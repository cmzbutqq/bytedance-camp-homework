# 开发指南

## 项目架构

本项目采用混合架构（Hybrid Architecture），结合 Web 技术和原生能力。

```
┌─────────────────┐
│   Web 前端      │  Vue 3 + Tailwind CSS
│  (Vue 3)        │
└────────┬────────┘
         │ WebSocket
         │
┌────────▼────────┐
│   Node.js       │  Express + Socket.io
│   服务端        │
└────────┬────────┘
         │
┌────────▼────────┐
│  Android App    │  Kotlin + WebView
│  (WebView)      │  + 原生桥接
└─────────────────┘
```

## 模块说明

### 前端模块 (`frontend/`)

**职责：**
- 用户界面展示
- 用户交互处理
- WebSocket 通信（客户端）

**核心文件：**
- `src/App.vue` - 主组件，包含聊天界面
- `src/main.js` - 应用入口
- `src/style.css` - 全局样式（Tailwind CSS）

**技术要点：**
- 使用 Vue 3 Composition API
- Socket.io-client 处理 WebSocket 连接
- 响应式设计，适配移动端

### 服务端模块 (`server/`)

**职责：**
- WebSocket 服务器
- 消息广播
- 用户连接管理

**核心文件：**
- `server.js` - 服务器主文件

**技术要点：**
- Socket.io 处理 WebSocket 连接
- 支持跨域（CORS）
- 用户在线状态管理

### Android 模块 (`android/`)

**职责：**
- 承载 WebView
- 提供原生能力桥接
- 权限管理

**核心文件：**
- `app/src/main/java/com/chatapp/MainActivity.kt` - 主 Activity
- `WebAppInterface` - JavaScript 接口类

**技术要点：**
- `@JavascriptInterface` 暴露原生方法
- 动态权限请求
- WebView 配置和优化

## 通信流程

### 消息发送流程

```
用户输入 → Vue 组件 → Socket.io-client → 
Node.js 服务端 → Socket.io 广播 → 
所有连接的客户端（包括 Android WebView）
```

### 原生方法调用流程

```
Vue 组件 → window.AndroidBridge → 
@JavascriptInterface → Kotlin 方法 → 
返回结果 → JavaScript 回调
```

## 开发工作流

### 1. 本地开发

1. 启动服务端：`cd server && npm start`
2. 启动前端：`cd frontend && npm run dev`
3. 在浏览器访问 `http://localhost:5173` 测试
4. 在 Android Studio 中运行 Android 应用

### 2. 调试技巧

**前端调试：**
- 使用浏览器开发者工具
- Vue DevTools 插件
- Console 日志

**服务端调试：**
- Node.js 控制台输出
- Socket.io 连接日志

**Android 调试：**
- Android Studio Logcat
- Chrome DevTools（远程调试 WebView）
- `adb logcat` 命令行工具

### 3. 真机测试

1. 确保手机和电脑在同一 WiFi 网络
2. 获取电脑 IP 地址（如 `192.168.1.100`）
3. 修改 `MainActivity.kt` 中的 URL
4. 确保防火墙允许端口访问

## 常见问题

### Q: Android WebView 无法加载页面
**A:** 检查：
- 网络权限是否授予
- URL 是否正确（模拟器用 `10.0.2.2`，真机用电脑 IP）
- `usesCleartextTraffic` 是否设置为 `true`（HTTP 需要）

### Q: Socket.io 连接失败
**A:** 检查：
- 服务端是否启动
- 端口是否被占用
- CORS 配置是否正确
- 网络连接是否正常

### Q: JavaScript 桥接不工作
**A:** 检查：
- `@JavascriptInterface` 注解是否正确
- 方法是否在 UI 线程中调用
- WebView JavaScript 是否启用

## 代码规范

### 命名规范
- **文件命名**：使用 kebab-case（如 `activity-main.xml`）
- **类命名**：使用 PascalCase（如 `MainActivity`）
- **变量命名**：使用 camelCase（如 `userId`）

### 代码组织
- 按功能模块组织代码
- 保持函数单一职责
- 添加必要的注释

### Git 提交
- 提交信息清晰明确
- 相关改动一起提交
- 避免提交临时文件和构建产物

